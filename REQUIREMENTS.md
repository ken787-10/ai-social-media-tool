# AI Social Media Tool - 要件定義書

## 1. プロジェクト概要
LINEユーザーが送信したメッセージ（画像またはテキスト）をもとに、特定の著名人スタイルでツイート/インスタグラム投稿文を自動生成するAIチャットボット。

## 2. 技術スタック
- **Backend**: Node.js + TypeScript
- **Deployment**: Vercel
- **LINE Integration**: LINE Messaging API
- **AI**: OpenAI API (GPT-4)
- **Image Processing**: OpenAI Vision API
- **Repository**: GitHub (ai-social-media-tool)

## 3. 主要機能

### 3.1 テキストメッセージ処理
- ユーザーがテキストを送信
- スタイル指定を自然言語から抽出（例：「ASKA風で書いて」）
- 文字数指定を抽出（30, 50, 70, 100 または 30%, 50%, 70%, 100%）
- 指定がない場合はデフォルト（桑田佳祐風、100%）
- 画像待機中の場合は、スタイル指定として処理

### 3.2 画像メッセージ処理
- 対応形式：JPEG, PNG
- 最大サイズ：20MB
- 処理フロー：
  1. 画像受信・一時保存
  2. スタイル選択を促すテキストメッセージを返信
  3. ユーザーがテキストでスタイルを指定（例：「桑田風50」）
  4. 指定されたスタイル・文字数で画像に基づくコメント生成

### 3.3 スタイル一覧
1. **ASKA風**：詩的、哲学的、感性的
2. **桑田佳祐風**：ユーモラス、言葉遊び、独特な視点（デフォルト）
3. **ミッションインポッシブル風**：スパイ映画風、緊迫感、アクション満載
4. **大前研一風**：論理的、ビジネス視点、洞察的
5. **インスタグラム投稿用**：映える、ハッシュタグ付き、絵文字使用

### 3.4 文字数制御
- 30%指定：約84文字以内
- 50%指定：約140文字以内
- 70%指定：約196文字以内
- 100%指定：約280文字以内
- 数字のみでも認識可能（例：「桑田風30」「ASKA風50」）

## 4. システム構成

### 4.1 エンドポイント
- `/api/webhook`：LINE Webhook受信用

### 4.2 環境変数
- `LINE_CHANNEL_SECRET`：LINE Channel Secret
- `LINE_CHANNEL_ACCESS_TOKEN`：LINE Channel Access Token
- `OPENAI_API_KEY`：OpenAI API Key

### 4.3 セッション管理
- メモリ内管理（Map使用）
- タイムアウト：10分
- 保存データ：userId, imageId, selectedStyle, timestamp

## 5. 非機能要件

### 5.1 パフォーマンス
- レスポンス時間：5秒以内
- 同時接続：Vercel無料枠の制限内

### 5.2 セキュリティ
- LINE署名検証
- 環境変数による秘密情報管理
- HTTPS通信必須

### 5.3 エラーハンドリング
- API制限時：わかりやすいエラーメッセージ
- 画像サイズ超過：適切な案内メッセージ
- スタイル不明：デフォルト動作

## 6. UI/UX設計

### 6.1 画像送信時のフロー
1. ユーザー：画像送信
2. Bot：スタイル選択を促すテキストメッセージを返信
   ```
   画像を受信しました📸
   
   どのスタイルで投稿文を作成しますか？
   
   使用例：
   ・ASKA風
   ・桑田風30
   ・ミッション50
   ・大前風
   ・インスタ風70
   
   数字は文字数の割合です（30/50/70/100%）
   ```
3. ユーザー：テキストでスタイルと文字数を指定（例：「桑田風50」）
4. Bot：生成されたテキスト返信

### 6.2 テキスト送信時のフロー
1. ユーザー：「桑田風で今日の天気について」
2. Bot：桑田佳祐風のテキスト生成・返信

## 7. デプロイメント

### 7.1 Vercel設定
- GitHub連携による自動デプロイ
- 環境変数設定
- Serverless Functions使用

### 7.2 LINE設定
- Webhook URL：`https://[project-name].vercel.app/api/webhook`
- Webhook有効化
- 応答メッセージ無効化

## 8. 今後の拡張可能性
- スタイル追加
- 音声メッセージ対応
- グループチャット対応
- 利用統計機能
- プロンプトのWeb管理機能（実装済み）

## 9. 管理機能
- **管理画面URL**: `/api/admin`
- パスワード認証によるアクセス制御
- 各スタイルのプロンプトをブラウザから編集可能
- リアルタイムで変更が反映
- **注意**: Vercel環境では編集内容は一時的（数時間で消える）
- 永続化には環境変数（PROMPT_ASKA, PROMPT_KUWATA等）を使用

## 10. 2024年6月22日 実施改善内容

### 10.1 品質改善
- **Temperature設定**: 0.8から0.7に変更（n8nと同等の設定）
- **桑田風プロンプト改善**:
  - 「ひとりコックリさん」の精神を重視する指示を追加
  - 表現パターンの多様化指示を追加
  - ポジティブ表現の徹底指示を追加
- **デフォルトスタイル**: ミッション風から桑田風に変更

### 10.2 UX改善
- **文字数表示の削除**: X（Twitter）へのコピペを容易にするため
- **プロンプトの簡潔化**: 文字数制限の説明をプロンプトから削除

### 10.3 技術的修正
- TypeScriptの型エラー修正（health.ts）
- Vercel自動デプロイの設定（Deploy Hook）
- 動的import問題の修正（サーバーレス環境対応）
- 管理画面に明確な警告を追加（Vercel環境での一時性について）

### 10.4 GitHubからVercelへの自動デプロイが失敗した原因と対策

#### 原因
1. **GitHub連携の設定不足**: Vercelプロジェクトの初期設定時にGitHub連携が正しく設定されていなかった
2. **Deploy Hookの未設定**: 自動デプロイのトリガーとなるDeploy Hookが作成されていなかった
3. **権限の問題**: GitHubリポジトリへのアクセス権限が不足していた可能性

#### 実施した対策
1. **Deploy Hookの作成**: Vercel管理画面でDeploy Hookを作成し、GitHubプッシュ時の自動デプロイを有効化
2. **手動デプロイ**: 緊急時は管理画面から手動でデプロイを実行

#### 今後の失敗を防ぐための対策
1. **初期設定チェックリスト**:
   - [ ] Vercelプロジェクト作成時にGitHub連携を確認
   - [ ] Deploy Hookが有効になっているか確認
   - [ ] 最初のコミット後、自動デプロイが動作するか確認
   
2. **デプロイ確認手順**:
   - `git push`後、Vercelダッシュボードでデプロイ状態を確認
   - デプロイが開始されない場合は、Deploy Hook設定を確認
   - ビルドエラーが発生した場合は、ログを確認して即座に修正

3. **CLAUDE.mdへの記載**:
   - デプロイ確認手順を明記
   - トラブルシューティングガイドを追加
   - Deploy Hook URLなどの重要情報を記録